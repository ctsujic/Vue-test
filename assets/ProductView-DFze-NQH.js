import{_ as pt,j as Pt,r as i,o as at,a,h as n,b as t,i as A,w as k,d as x,v as N,n as I,k as ht,F as y,f as E,g as M,l as ut,m as yt,M as ot,t as s,e as K,p as ft,q as nt}from"./index-tvMXVzfh.js";import{$ as wt}from"./dataTables.bootstrap5.min-DfwQAa5e.js";const It={class:"card"},kt={class:"card-body"},gt={class:"row"},Et={class:"col-md-6 mb-3"},Mt={class:"input-group"},Nt={key:0,class:"invalid-feedback"},Lt={class:"col-md-6 mb-3"},Ct={class:"input-group"},At=["disabled","onKeydown"],$t={id:"productList"},St=["value"],Dt={class:"col-md-6 mb-3"},xt={class:"text-end"},Tt=["disabled"],Rt=Object.assign({name:"ProductForm"},{__name:"ProductForm",setup(Y){const f=Pt(),d=i({P_NAME:"",P_NS:"",P_PRICE:0}),p=i([]),_=i(!1),P=i(!1);i(!1),i([]),i(-1);const g=async()=>{try{const{data:c}=await M.get("/products");p.value=c}catch(c){console.error("獲取產品列表失敗：",c)}},r=()=>{d.value.P_NS?(_.value=p.value.some(c=>c.P_NS===d.value.P_NS),P.value=_.value):(_.value=!1,P.value=!1)},m=async()=>{if(r(),_.value){alert("條碼重複，請修改後再試");return}try{await M.post("/products",d.value),alert("產品新增成功"),d.value={P_NAME:"",P_NS:"",P_PRICE:0,P_STOCK:0},await ut(),document.getElementById("P_NS").focus(),f.push("/product")}catch(c){console.error("新增產品失敗：",c),alert("新增產品失敗")}};at(()=>{g()});const $=()=>{};return(c,u)=>(n(),a("div",It,[t("div",kt,[u[6]||(u[6]=t("h3",{class:"card-title mb-4"},"新增產品",-1)),t("form",{onSubmit:A(m,["prevent"])},[t("div",gt,[t("div",Et,[u[3]||(u[3]=t("label",{for:"P_NS",class:"form-label"},"條碼",-1)),t("div",Mt,[k(t("input",{type:"text",class:I(["form-control",{"is-invalid":P.value}]),id:"P_NS","onUpdate:modelValue":u[0]||(u[0]=h=>d.value.P_NS=h),onBlur:r,required:""},null,34),[[N,d.value.P_NS]]),P.value?(n(),a("div",Nt,"此條碼已存在")):x("",!0)])]),t("div",Lt,[u[4]||(u[4]=t("label",{for:"P_NAME",class:"form-label"},"書名",-1)),t("div",Ct,[k(t("input",{type:"text",class:"form-control",id:"P_NAME","onUpdate:modelValue":u[1]||(u[1]=h=>d.value.P_NAME=h),list:"productList",disabled:c.isSubmitting,onFocus:g,onKeydown:ht(A($,["prevent"]),["enter"])},null,40,At),[[N,d.value.P_NAME]]),t("datalist",$t,[(n(!0),a(y,null,E(p.value,h=>(n(),a("option",{key:h.P_ID,value:h.P_NAME},null,8,St))),128))])])]),t("div",Dt,[u[5]||(u[5]=t("label",{for:"P_PRICE",class:"form-label"},"定價",-1)),k(t("input",{type:"number",class:"form-control",id:"P_PRICE","onUpdate:modelValue":u[2]||(u[2]=h=>d.value.P_PRICE=h),min:"0",step:"1",required:""},null,512),[[N,d.value.P_PRICE]])])]),t("div",xt,[t("button",{type:"submit",class:"btn btn-primary",disabled:_.value},"儲存",8,Tt)])],32)])]))}}),Ot=pt(Rt,[["__scopeId","data-v-094fb86c"]]),Vt={class:"card"},Ft={class:"card-body"},Ut={key:0,class:"alert alert-danger",role:"alert"},Bt={class:"mb-3"},Kt={class:"text-muted"},Yt={class:"text-danger ms-2"},qt={class:"text-danger ms-2"},Qt=["onClick"],jt={class:"text-danger ms-2"},zt={class:"text-danger ms-2"},Xt=["onClick"],Gt=["onClick"],Ht=["onClick"],Jt={class:"modal fade",id:"locationModal",tabindex:"-1"},Wt={class:"modal-dialog"},Zt={class:"modal-content"},tl={class:"modal-body"},ll={class:"mb-3"},el={class:"form-label"},sl={class:"text-muted"},ol={class:"row"},nl={class:"col-md-6 mb-3"},al={class:"dropdown"},ul=["onMousedown","onMouseover"],il={class:"col-md-6 mb-3"},dl={class:"dropdown"},rl=["onMousedown","onMouseover"],cl={class:"modal fade",id:"purchaseModal",tabindex:"-1"},vl={class:"modal-dialog modal-lg"},_l={class:"modal-content"},ml={class:"modal-body"},bl={class:"mb-3"},pl={class:"form-label"},Pl={class:"text-muted"},hl={class:"list-group list-group-horizontal"},yl={class:"list-group-item list-group-item-warning"},fl={class:"list-group-item list-group-item-warning"},wl={class:"list-group-item list-group-item-warning"},Il={class:"list-group-item list-group-item-warning"},kl={class:"btn-group mb-3"},gl={class:"table-container"},El={key:0,class:"table-responsive custom-scrollbar"},Ml={class:"table"},Nl={key:0},Ll={key:1,class:"table-responsive custom-scrollbar"},Cl={class:"table"},Al={key:0},$l={key:2,class:"table-responsive custom-scrollbar"},Sl={class:"table"},Dl={key:0},xl={__name:"ProductList",setup(Y){const f=i([]),d=i(!0),p=i(null),_=i(null),P=i({P_NAME:"",P_PRICE:0}),g=i([]),r=i(null),m=i({Location_1:"",Location_2:""});let $=null,c=null;const u=i("purchase"),h=i([]),V=i([]),F=i([]);let q=null;const it={language:{processing:"處理中...",loadingRecords:"載入中...",lengthMenu:"顯示 _MENU_ 項結果",zeroRecords:"沒有符合的結果",info:"顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",infoEmpty:"顯示第 0 至 0 項結果，共 0 項",infoFiltered:"(從 _MAX_ 項結果中過濾)",search:"搜尋:",paginate:{first:"第一頁",previous:"上一頁",next:"下一頁",last:"最後一頁"}},pageLength:50,order:[[0,"asc"]],destroy:!0,deferRender:!0},T=async()=>{try{c&&(c.destroy(),c=null);const o=d.value?{stock:"true"}:{},{data:l}=await M.get("/products",{params:o});f.value=l,await ut(),c=wt("#productTable").DataTable(it)}catch(o){console.error("獲取產品列表失敗：",o),p.value="獲取產品資料失敗，請稍後重試"}};yt(d,T);const dt=o=>{_.value=o.P_ID,P.value={P_NAME:o.P_NAME,P_PRICE:o.P_PRICE}},rt=()=>{_.value=null,P.value={P_NAME:"",P_PRICE:0}},ct=async o=>{try{await M.patch(`/products/${o}`,P.value),alert("更新成功"),_.value=null,T()}catch(l){console.error("更新產品失敗：",l),alert("更新失敗")}},vt=async()=>{try{const{data:o}=await M.get("/locations");g.value=o}catch(o){console.error("獲取倉儲位置失敗：",o)}},_t=o=>{r.value=o,m.value={Location_1:o.Location_1||"",Location_2:o.Location_2||""},$.show()},mt=async()=>{console.log("locationData = ",m.value);try{await M.patch(`/products/${r.value.P_ID}`,m.value),alert("更新成功"),$.hide(),T()}catch(o){console.error("更新倉儲位置失敗：",o),alert("更新失敗")}},L=i(!1),C=i(!1),R=i([]),O=i([]),S=i(-1),D=i(-1),Q=o=>{const l=o===1?m.value.Location_1:m.value.Location_2,v=g.value.filter(w=>w.L_NAME.toLowerCase().includes(l.toLowerCase()));o===1?(R.value=v,L.value=!0,S.value=-1):(O.value=v,C.value=!0,D.value=-1)},j=o=>{o===1?(R.value=g.value,L.value=!0,S.value=-1):(O.value=g.value,C.value=!0,D.value=-1)},z=o=>{requestAnimationFrame(()=>{o===1?L.value=!1:C.value=!1})},U=(o,l)=>{o===1?(m.value.Location_1=l,L.value=!1):(m.value.Location_2=l,C.value=!1)},X=(o,l)=>{const v=l===1?S:D,w=l===1?R:O;switch(o.key){case"ArrowDown":o.preventDefault(),v.value<w.value.length-1?v.value++:v.value=0;break;case"ArrowUp":o.preventDefault(),v.value>0?v.value--:v.value=w.value.length-1;break;case"Enter":o.preventDefault(),v.value>-1&&U(l,w.value[v.value].L_NAME);break;case"Escape":o.preventDefault(),l===1?L.value=!1:C.value=!1;break}},bt=async o=>{r.value=o;try{const{data:l}=await M.get(`/products/${o.P_ID}/history`);h.value=l.purchases,V.value=l.sales,F.value=l.purchaseReturns,console.log("退貨紀錄：",l),q.show()}catch(l){console.error("獲取紀錄失敗：",l),alert("獲取紀錄失敗")}};return at(()=>{T(),vt(),$=new ot(document.getElementById("locationModal")),q=new ot(document.getElementById("purchaseModal"))}),(o,l)=>{var v,w,G,H,J,W,Z,tt,lt,et,st;return n(),a("div",null,[t("div",Vt,[t("div",Ft,[p.value?(n(),a("div",Ut,s(p.value),1)):x("",!0),t("div",Bt,[t("label",null,[k(t("input",{type:"checkbox","onUpdate:modelValue":l[0]||(l[0]=e=>d.value=e)},null,512),[[ft,d.value]]),l[16]||(l[16]=K(" 只顯示有庫存 "))])]),(n(),a("table",{id:"productTable",class:"table table-hover",key:d.value},[l[18]||(l[18]=t("thead",null,[t("tr",null,[t("th",null,"書名/條碼"),t("th",null,"定價"),t("th",null,"平均成本"),t("th",null,"庫存"),t("th",null,"庫存額"),t("th",null,"銷量"),t("th",null,"操作")])],-1)),t("tbody",null,[(n(!0),a(y,null,E(f.value,e=>(n(),a("tr",{key:e.P_ID},[t("td",null,[_.value===e.P_ID?(n(),a(y,{key:0},[k(t("input",{type:"text",class:"form-control form-control-sm mb-1","onUpdate:modelValue":l[1]||(l[1]=b=>P.value.P_NAME=b)},null,512),[[N,P.value.P_NAME]]),t("small",Kt,s(e.P_NS),1),t("small",Yt,s(e.Location_1),1),t("small",qt,s(e.Location_2),1)],64)):(n(),a(y,{key:1},[K(s(e.P_NAME),1),l[17]||(l[17]=t("br",null,null,-1)),t("a",{href:"#",onClick:A(b=>_t(e),["prevent"]),class:"text-muted"},s(e.P_NS),9,Qt),t("small",jt,s(e.Location_1),1),t("small",zt,s(e.Location_2),1)],64))]),t("td",null,[_.value===e.P_ID?k((n(),a("input",{key:0,type:"number",class:"form-control form-control-sm","onUpdate:modelValue":l[2]||(l[2]=b=>P.value.P_PRICE=b),min:"0",step:"1"},null,512)),[[N,P.value.P_PRICE]]):(n(),a(y,{key:1},[K(s(e.P_PRICE),1)],64))]),t("td",null,[t("a",{href:"#",onClick:A(b=>bt(e),["prevent"]),class:"text-primary"},s(e.P_COST),9,Xt)]),t("td",null,s(e.P_STOCK),1),t("td",null,s(e.P_INVENTORY),1),t("td",null,s(e.P_SALESTOTAL),1),t("td",null,[_.value===e.P_ID?(n(),a(y,{key:0},[t("button",{class:"btn btn-sm btn-success me-2",onClick:b=>ct(e.P_ID)}," 完成 ",8,Gt),t("button",{class:"btn btn-sm btn-secondary",onClick:rt},"取消")],64)):(n(),a("button",{key:1,class:"btn btn-sm btn-outline-primary",onClick:b=>dt(e)}," 編輯 ",8,Ht))])]))),128))])]))])]),t("div",Jt,[t("div",Wt,[t("div",Zt,[l[23]||(l[23]=t("div",{class:"modal-header"},[t("h5",{class:"modal-title"},"編輯倉儲位置"),t("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"})],-1)),t("div",tl,[t("div",ll,[t("label",el,"書名："+s((v=r.value)==null?void 0:v.P_NAME),1),l[19]||(l[19]=t("br",null,null,-1)),t("small",sl,"條碼："+s((w=r.value)==null?void 0:w.P_NS),1)]),t("div",ol,[t("div",nl,[l[20]||(l[20]=t("label",{class:"form-label"},"倉儲位置1",-1)),t("div",al,[k(t("input",{type:"text",class:"form-control","onUpdate:modelValue":l[3]||(l[3]=e=>m.value.Location_1=e),onInput:l[4]||(l[4]=e=>Q(1)),onFocus:l[5]||(l[5]=e=>j(1)),onBlur:l[6]||(l[6]=e=>z(1)),onKeydown:l[7]||(l[7]=e=>X(e,1))},null,544),[[N,m.value.Location_1]]),t("ul",{class:I(["dropdown-menu w-100",{show:L.value}])},[(n(!0),a(y,null,E(R.value,(e,b)=>(n(),a("li",{key:e.id,class:I({active:b===S.value})},[t("a",{class:"dropdown-item",href:"#",onMousedown:A(B=>U(1,e.L_NAME),["prevent"]),onMouseover:B=>S.value=b},s(e.L_NAME),41,ul)],2))),128))],2)])]),t("div",il,[l[21]||(l[21]=t("label",{class:"form-label"},"倉儲位置2",-1)),t("div",dl,[k(t("input",{type:"text",class:"form-control","onUpdate:modelValue":l[8]||(l[8]=e=>m.value.Location_2=e),onInput:l[9]||(l[9]=e=>Q(2)),onFocus:l[10]||(l[10]=e=>j(2)),onBlur:l[11]||(l[11]=e=>z(2)),onKeydown:l[12]||(l[12]=e=>X(e,2))},null,544),[[N,m.value.Location_2]]),t("ul",{class:I(["dropdown-menu w-100",{show:C.value}])},[(n(!0),a(y,null,E(O.value,(e,b)=>(n(),a("li",{key:e.id,class:I({active:b===D.value})},[t("a",{class:"dropdown-item",href:"#",onMousedown:A(B=>U(2,e.L_NAME),["prevent"]),onMouseover:B=>D.value=b},s(e.L_NAME),41,rl)],2))),128))],2)])])])]),t("div",{class:"modal-footer"},[l[22]||(l[22]=t("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"},"取消",-1)),t("button",{type:"button",class:"btn btn-primary",onClick:mt},"儲存")])])])]),t("div",cl,[t("div",vl,[t("div",_l,[l[32]||(l[32]=t("div",{class:"modal-header"},[t("h5",{class:"modal-title"},"商品紀錄"),t("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"})],-1)),t("div",ml,[t("div",bl,[t("label",pl,"書名："+s((G=r.value)==null?void 0:G.P_NAME),1),l[24]||(l[24]=t("br",null,null,-1)),t("small",Pl,"條碼："+s((H=r.value)==null?void 0:H.P_NS),1),l[25]||(l[25]=t("br",null,null,-1)),t("ul",hl,[t("li",yl," 總進貨："+s((J=r.value)==null?void 0:J.P_TQUANTITY)+"本 ",1),t("li",fl," 總銷售："+s((W=r.value)==null?void 0:W.P_SALESTOTAL)+"本 ",1),t("li",wl," 庫存剩："+s((Z=r.value)==null?void 0:Z.P_STOCK)+"本 ",1),t("li",Il," 庫存額："+s((tt=r.value)==null?void 0:tt.P_INVENTORY)+"元 ",1)])]),t("div",kl,[t("button",{class:I(["btn",{"btn-success":u.value==="purchase","btn-outline-success":u.value!=="purchase"}]),onClick:l[13]||(l[13]=e=>u.value="purchase")}," 進貨紀錄 ",2),t("button",{class:I(["btn",{"btn-success":u.value==="sales","btn-outline-success":u.value!=="sales"}]),onClick:l[14]||(l[14]=e=>u.value="sales")}," 銷售紀錄 ",2),t("button",{class:I(["btn",{"btn-success":u.value==="purchaseReturn","btn-outline-success":u.value!=="purchaseReturn"}]),onClick:l[15]||(l[15]=e=>u.value="purchaseReturn")}," 退貨紀錄 ",2)]),t("div",gl,[u.value==="purchase"?(n(),a("div",El,[t("table",Ml,[l[27]||(l[27]=t("thead",null,[t("tr",null,[t("th",null,"進貨單號"),t("th",null,"供應商"),t("th",null,"數量"),t("th",null,"折扣"),t("th",null,"售價")])],-1)),t("tbody",null,[(lt=h.value)!=null&&lt.length?(n(!0),a(y,{key:1},E(h.value,e=>(n(),a("tr",{key:e.ID},[t("td",null,s(e.PI_ID),1),t("td",null,s(e.purchase.supplier.S_NAME),1),t("td",null,s(e.PI_QUANTITY),1),t("td",null,s(e.PI_FOLD),1),t("td",null,s(e.PI_COST),1)]))),128)):(n(),a("tr",Nl,l[26]||(l[26]=[t("td",{colspan:"5",class:"text-center"},"無進貨紀錄",-1)])))])])])):x("",!0),u.value==="sales"?(n(),a("div",Ll,[t("table",Cl,[l[29]||(l[29]=t("thead",null,[t("tr",null,[t("th",null,"訂單編號"),t("th",null,"客戶"),t("th",null,"數量"),t("th",null,"折扣"),t("th",null,"售價")])],-1)),t("tbody",null,[(et=V.value)!=null&&et.length?(n(!0),a(y,{key:1},E(V.value,e=>(n(),a("tr",{key:e.ID},[t("td",null,s(e.SI_ID),1),t("td",null,s(e.sales.customer.C_NAME),1),t("td",null,s(e.SI_QUANTITY),1),t("td",null,s(e.SI_FOLD),1),t("td",null,s(e.SI_COST),1)]))),128)):(n(),a("tr",Al,l[28]||(l[28]=[t("td",{colspan:"5",class:"text-center"},"無銷售紀錄",-1)])))])])])):x("",!0),u.value==="purchaseReturn"?(n(),a("div",$l,[t("table",Sl,[l[31]||(l[31]=t("thead",null,[t("tr",null,[t("th",null,"退貨單號"),t("th",null,"供應商"),t("th",null,"數量"),t("th",null,"折扣"),t("th",null,"售價")])],-1)),t("tbody",null,[(st=F.value)!=null&&st.length?(n(!0),a(y,{key:1},E(F.value,e=>(n(),a("tr",{key:e.ID},[t("td",null,s(e.PI_ID),1),t("td",null,s(e.purchase_return.supplier.S_NAME),1),t("td",null,s(e.PI_QUANTITY),1),t("td",null,s(e.PI_FOLD),1),t("td",null,s(e.PI_COST),1)]))),128)):(n(),a("tr",Dl,l[30]||(l[30]=[t("td",{colspan:"5",class:"text-center"},"無退貨紀錄",-1)])))])])])):x("",!0)])]),l[33]||(l[33]=t("div",{class:"modal-footer"},[t("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"},"關閉")],-1))])])])])}}},Tl={class:"row mb-4"},Rl={class:"col text-end"},Fl=Object.assign({name:"ProductView"},{__name:"ProductView",setup(Y){const f=i(!1);return(d,p)=>(n(),a("div",null,[t("div",Tl,[p[1]||(p[1]=t("div",{class:"col"},[t("h2",null,"產品管理")],-1)),t("div",Rl,[t("button",{class:"btn btn-primary",onClick:p[0]||(p[0]=_=>f.value=!f.value)},s(f.value?"返回列表":"新增產品"),1)])]),f.value?(n(),nt(Ot,{key:0})):(n(),nt(xl,{key:1}))]))}});export{Fl as default};
