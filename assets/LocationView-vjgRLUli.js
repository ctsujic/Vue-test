import{_ as W,r as n,o as Z,a as _,b as t,F as h,f as k,t as r,w as N,v as x,n as P,g as E,M as G,h as m,e as H,i as K}from"./index-tvMXVzfh.js";const J=(y,A,i)=>{const{filtered:f,activeIndex:l,visible:u}=A;if(u.value)switch(y.key){case"ArrowDown":case"ArrowUp":y.preventDefault();const L=y.key==="ArrowDown",p=f.value.length-1;L&&l.value<p?l.value++:L?l.value=0:!L&&l.value>0?l.value--:L||(l.value=p);break;case"Enter":y.preventDefault(),l.value>-1&&i(f.value[l.value]);break;case"Escape":y.preventDefault(),u.value=!1;break}},Q={class:"card mb-4"},X={class:"card-body"},Y={class:"btn-group",role:"group",style:{display:"flex","flex-wrap":"wrap"}},tt=["title","onClick"],et={class:"badge rounded-pill bg-success ms-1"},ot={class:"card"},st={class:"card-body"},lt={class:"table-responsive"},at={class:"table table-hover"},nt={key:0},it=["onClick"],dt={class:"modal fade",id:"locationModal",tabindex:"-1"},rt={class:"modal-dialog"},ut={class:"modal-content"},ct={class:"modal-body"},vt={class:"mb-3"},bt={class:"form-label"},_t={class:"text-muted"},mt={class:"row"},Lt={class:"col-md-6 mb-3"},ft={class:"dropdown"},wt=["onMousedown","onMouseover"],pt={class:"col-md-6 mb-3"},Mt={class:"dropdown"},yt=["onMousedown","onMouseover"],At={class:"modal fade",id:"addLocationModal",tabindex:"-1"},Et={class:"modal-dialog"},ht={class:"modal-content"},kt={class:"modal-body"},Nt={class:"mb-3"},xt={class:"mb-3"},Pt=Object.assign({name:"LocationView"},{__name:"LocationView",setup(y){const A=n([]),i=n([]),f=n([]),l=n(null),u=n(null);let L=null,p=null;const c=n({Location_1:"",Location_2:""}),w=n({L_NAME:"",SL_REMARK:""}),v={1:{visible:n(!1),filtered:n([]),activeIndex:n(-1)},2:{visible:n(!1),filtered:n([]),activeIndex:n(-1)}},g=o=>!o||o.trim()==="",D=o=>!g(o),I=(o,e)=>(o||(o=new G(document.getElementById(e))),o),T=async()=>{try{const{data:o}=await E.get("/products");return f.value=o,o}catch(o){return console.error("獲取產品列表失敗：",o),[]}},C=async()=>{try{const[o,e]=await Promise.all([E.get("/locations"),T()]);A.value=o.data.map(a=>({...a,product_count:U(a,e)}))}catch(o){console.error("獲取倉儲位置失敗：",o)}},U=(o,e)=>e.filter(a=>a.Location_1===o.L_NAME||a.Location_2===o.L_NAME).reduce((a,d)=>a+(d.P_STOCK||0),0),R=()=>{if(!u.value){i.value=f.value;return}i.value=f.value.filter(o=>o.Location_1===u.value.L_NAME||o.Location_2===u.value.L_NAME)},F=async o=>{u.value=o,await R()},$=()=>{i.value=f.value.filter(o=>o.P_STOCK>0&&g(o.Location_1)),u.value=null},V=async()=>{try{const{data:o}=await E.get("/products/zero");i.value=o!=null&&o.product?Array.isArray(o.product)?o.product:[o.product]:[],u.value=null}catch(o){console.error("獲取無庫存產品失敗：",o),i.value=[],alert("獲取無庫存產品失敗，請稍後再試")}},z=o=>{l.value=o,c.value={Location_1:o.Location_1||"",Location_2:o.Location_2||""},L=I(L,"locationModal"),L.show()},j=()=>{w.value={L_NAME:"",SL_REMARK:""},p=I(p,"addLocationModal"),p.show()},b=(o,e,a="")=>{const d=v[o];switch(e){case"filter":d.filtered.value=A.value.filter(s=>s.L_NAME.toLowerCase().includes(a.toLowerCase())),d.visible.value=!0;break;case"show":b(o,"filter",o===1?c.value.Location_1:c.value.Location_2);break;case"hide":setTimeout(()=>d.visible.value=!1,200);break;case"select":o===1?c.value.Location_1=a:c.value.Location_2=a,d.visible.value=!1;break}},B=async()=>{try{await E.patch(`/products/${l.value.P_ID}`,c.value),alert("更新成功"),L.hide(),await C(),l.value.P_STOCK>0&&g(l.value.Location_1)?$():l.value.P_STOCK<=0&&(D(l.value.Location_1)||D(l.value.Location_2))?await V():u.value?await R():i.value=f.value}catch(o){console.error("更新倉儲位置失敗：",o),alert("更新失敗")}},q=async()=>{try{if(!w.value.L_NAME.trim()){alert("請輸入倉儲位置");return}if(A.value.some(o=>o.L_NAME===w.value.L_NAME)){alert("倉儲位置已存在");return}await E.post("/locations",w.value),alert("新增成功"),p.hide(),await C()}catch(o){console.error("新增倉儲位置失敗：",o),alert("新增失敗")}},O=(o,e)=>{const a=v[e];if(o.key==="Enter"&&!a.visible.value){o.preventDefault(),B();return}J(o,a,d=>{b(e,"select",d.L_NAME)})};return Z(()=>{C()}),(o,e)=>{var a,d;return m(),_("div",null,[e[23]||(e[23]=t("div",{class:"row mb-4"},[t("div",{class:"col"},[t("h2",null,"倉儲管理")])],-1)),t("div",Q,[t("div",X,[t("div",Y,[t("div",{class:"mb-2 mx-2"},[t("button",{class:"btn btn-sm btn-primary",onClick:j}," 新增倉儲位置 ")]),t("div",{class:"mb-2 mx-2"},[t("button",{class:"btn btn-sm btn-outline-dark",onClick:$}," 有庫存沒倉位 ")]),t("div",{class:"mb-2 mx-2"},[t("button",{class:"btn btn-sm btn-outline-dark",onClick:V}," 清空無庫存的倉位 ")]),(m(!0),_(h,null,k(A.value,s=>(m(),_("div",{key:s.id,class:"mb-2 mx-2"},[t("button",{type:"button",class:"btn btn-sm btn-outline-dark",title:s.SL_REMARK,onClick:M=>F(s)},[H(r(s.L_NAME)+" ",1),t("span",et,r(s.product_count),1)],8,tt)]))),128))])])]),t("div",ot,[t("div",st,[t("div",lt,[t("table",at,[e[13]||(e[13]=t("thead",{class:"table-info"},[t("tr",null,[t("th",null,"條碼"),t("th",null,"書名"),t("th",null,"庫存"),t("th",null,"倉儲位置1"),t("th",null,"倉儲位置2")])],-1)),t("tbody",null,[!i.value||i.value.length===0?(m(),_("tr",nt,e[12]||(e[12]=[t("td",{colspan:"5",class:"text-center"},"暫無資料",-1)]))):(m(!0),_(h,{key:1},k(i.value,s=>(m(),_("tr",{key:s.P_ID},[t("td",null,[t("a",{href:"#",onClick:K(M=>z(s),["prevent"]),class:"text-dark text-decoration-none"},r(s.P_NS),9,it)]),t("td",null,r(s.P_NAME),1),t("td",null,r(s.P_STOCK),1),t("td",null,r(s.Location_1),1),t("td",null,r(s.Location_2),1)]))),128))])])])])]),t("div",dt,[t("div",rt,[t("div",ut,[e[18]||(e[18]=t("div",{class:"modal-header"},[t("h5",{class:"modal-title"},"編輯倉儲位置"),t("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"})],-1)),t("div",ct,[t("div",vt,[t("label",bt,"書名："+r((a=l.value)==null?void 0:a.P_NAME),1),e[14]||(e[14]=t("br",null,null,-1)),t("small",_t,"條碼："+r((d=l.value)==null?void 0:d.P_NS),1)]),t("div",mt,[t("div",Lt,[e[15]||(e[15]=t("label",{class:"form-label"},"倉儲位置1",-1)),t("div",ft,[N(t("input",{type:"text",class:"form-control","onUpdate:modelValue":e[0]||(e[0]=s=>c.value.Location_1=s),onInput:e[1]||(e[1]=s=>b(1,"filter",s.target.value)),onFocus:e[2]||(e[2]=s=>b(1,"show")),onBlur:e[3]||(e[3]=s=>b(1,"hide")),onKeydown:e[4]||(e[4]=s=>O(s,1))},null,544),[[x,c.value.Location_1]]),t("ul",{class:P(["dropdown-menu w-100",{show:v[1].visible.value}])},[(m(!0),_(h,null,k(v[1].filtered.value,(s,M)=>(m(),_("li",{key:s.id,class:P({active:M===v[1].activeIndex.value})},[t("a",{class:"dropdown-item",href:"#",onMousedown:K(S=>b(1,"select",s.L_NAME),["prevent"]),onMouseover:S=>v[1].activeIndex.value=M},r(s.L_NAME),41,wt)],2))),128))],2)])]),t("div",pt,[e[16]||(e[16]=t("label",{class:"form-label"},"倉儲位置2",-1)),t("div",Mt,[N(t("input",{type:"text",class:"form-control","onUpdate:modelValue":e[5]||(e[5]=s=>c.value.Location_2=s),onInput:e[6]||(e[6]=s=>b(2,"filter",s.target.value)),onFocus:e[7]||(e[7]=s=>b(2,"show")),onBlur:e[8]||(e[8]=s=>b(2,"hide")),onKeydown:e[9]||(e[9]=s=>O(s,2))},null,544),[[x,c.value.Location_2]]),t("ul",{class:P(["dropdown-menu w-100",{show:v[2].visible.value}])},[(m(!0),_(h,null,k(v[2].filtered.value,(s,M)=>(m(),_("li",{key:s.id,class:P({active:M===v[2].activeIndex.value})},[t("a",{class:"dropdown-item",href:"#",onMousedown:K(S=>b(2,"select",s.L_NAME),["prevent"]),onMouseover:S=>v[2].activeIndex.value=M},r(s.L_NAME),41,yt)],2))),128))],2)])])])]),t("div",{class:"modal-footer"},[e[17]||(e[17]=t("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"},"取消",-1)),t("button",{type:"button",class:"btn btn-primary",onClick:B},"儲存")])])])]),t("div",At,[t("div",Et,[t("div",ht,[e[22]||(e[22]=t("div",{class:"modal-header"},[t("h5",{class:"modal-title"},"新增倉儲位置"),t("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"})],-1)),t("div",kt,[t("div",Nt,[e[19]||(e[19]=t("label",{for:"L_NAME",class:"form-label"},"倉儲位置",-1)),N(t("input",{type:"text",class:"form-control",id:"L_NAME","onUpdate:modelValue":e[10]||(e[10]=s=>w.value.L_NAME=s),required:""},null,512),[[x,w.value.L_NAME]])]),t("div",xt,[e[20]||(e[20]=t("label",{for:"SL_REMARK",class:"form-label"},"備註",-1)),N(t("textarea",{class:"form-control",id:"SL_REMARK","onUpdate:modelValue":e[11]||(e[11]=s=>w.value.SL_REMARK=s),rows:"3"},null,512),[[x,w.value.SL_REMARK]])])]),t("div",{class:"modal-footer"},[e[21]||(e[21]=t("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"},"取消",-1)),t("button",{type:"button",class:"btn btn-primary",onClick:q},"儲存")])])])])])}}}),Ct=W(Pt,[["__scopeId","data-v-54ed5ff9"]]);export{Ct as default};
