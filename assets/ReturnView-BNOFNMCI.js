import{_ as tt,r as _,s as A,c as C,m as O,o as st,a as u,b as t,d as g,n as h,t as c,w as m,x as N,F as y,f,v as I,z as et,g as v,h as r,i as ot,l as at}from"./index-tvMXVzfh.js";import{I as lt}from"./ItemInput-DLxCqC5n.js";const nt={class:"container mt-4"},ct={class:"row mt-2 mb-4"},dt={class:"col"},ut={class:"btn-group",role:"group"},rt={key:0},it={class:"card mb-4"},pt={class:"card-header d-flex justify-content-between align-items-center"},_t={class:"btn-group"},vt={class:"card-body"},mt={class:"row"},bt={class:"col-md-3"},ht={class:"mb-3"},yt=["disabled"],ft=["value"],It={class:"col-md-3"},wt={class:"mb-3"},Pt=["disabled"],gt={class:"col-md-3"},kt={class:"mb-3"},St=["disabled"],Dt={class:"col-md-3"},Tt={class:"mb-3"},Ct=["disabled"],Mt={class:"card mb-4"},Et={class:"card-body"},Vt={class:"card"},At={class:"card-body"},Ot={class:"table"},Nt=["onUpdate:modelValue","onInput","disabled"],Ut=["onUpdate:modelValue","onBlur","disabled"],$t=["onUpdate:modelValue","onBlur","disabled"],Rt=["onClick","disabled"],qt={key:1},Bt={class:"card"},xt={class:"card-header"},Ft={class:"btn-group"},Yt=["onClick"],jt={class:"card-body"},Lt={class:"table"},Qt=["onClick"],zt={key:2,class:"modal fade show",tabindex:"-1",style:{display:"block"}},Gt={class:"modal-dialog"},Ht={class:"modal-content"},Jt={class:"modal-header"},Kt={class:"modal-title"},Wt={class:"d-flex align-items-center gap-2 ms-auto"},Xt={class:"modal-body"},Zt={class:"table"},ts={__name:"ReturnView",setup(ss){const k=_(!1),M=_([]),b=A({items:[]}),w=_("1"),l=_("add"),p=C(()=>l.value==="view"),a=A({supplier_id:"",date:new Date().toISOString().split("T")[0],amount:0,payment_method:"",status:1}),U=()=>{Object.assign(a,{supplier_id:"",date:new Date().toISOString().split("T")[0],amount:0,payment_method:"",status:1}),i.value=[],H.value=""},E=_([]),$=async()=>{try{const{data:o}=await v.get("/suppliers");E.value=o}catch(o){console.error("獲取廠商列表失敗：",o)}},R=_([]),q=async()=>{try{const{data:o}=await v.get("/products");R.value=o}catch(o){console.error("獲取產品資料失敗：",o)}},S=async()=>{try{const{data:o}=await v.get(`/purchaseReturns?status=${w.value}`);M.value=o}catch(o){console.error("獲取退貨列表失敗：",o)}},B=async o=>{try{const{data:e}=await v.get(`/purchaseReturns/${o}`);Object.assign(b,e),k.value=!0,console.log("獲取退貨明細成功：",Object.assign(b,e))}catch(e){console.error("獲取訂單明細失敗：",e)}},D=()=>{k.value=!1},x=C(()=>{switch(l.value){case"add":return"新增";case"view":return"編輯";case"edit":return"完成";default:return""}}),F=C(()=>{switch(l.value){case"add":return"btn-primary";case"view":return"btn-warning";case"edit":return"btn-success";default:return"btn-primary"}}),Y=async()=>{try{switch(l.value){case"add":if(!await j())return;l.value="view";break;case"view":await L(a.id),l.value="edit";break;case"edit":await Q(a.id),l.value="view";break}}catch(o){console.error("操作失敗:",o),alert("操作失敗，請稍後再試")}},j=async()=>{if(!z())return console.log("表單驗證失敗，停止執行"),!1;const o={supplier_id:a.supplier_id,date:a.date,amount:a.amount,payment_method:a.payment_method,status:1,items:i.value.map(s=>({product_id:s.product_id,price:s.price,quantity:s.quantity,discount:s.discount,cost:s.cost,total:s.total}))},{data:e}=await v.post("/purchaseReturns",o);return a.id=e.purchase_id,!0},L=async o=>{try{const{data:s}=await v.post(`/purchaseReturns/updateStatus/${o}`,{status:2});l.value="edit",console.log("更新訂單狀態成功"),alert("更新訂單成功")}catch(s){console.error("編輯訂單失敗：",s.message),alert("編輯訂單失敗")}},Q=async o=>{console.log("正在執行 updatePurchase= ",o,", status=",a.status,"post_status=",1);try{const{data:s}=await v.post(`/purchaseReturns/updateStatus/${o}`,{status:1,supplier_id:a.supplier_id,amount:a.amount,payment_method:a.payment_method,items:i.value.map(n=>({product_id:n.product_id,price:n.price,quantity:n.quantity,discount:n.discount,cost:n.cost,total:n.total}))});l.value="view",console.log("更新訂單成功"),alert("更新訂單成功")}catch(s){console.error("編輯訂單失敗：",s.message),alert("編輯訂單失敗")}},z=()=>a.supplier_id?a.payment_method?i.value.length===0?(alert("請至少新增一筆退貨明細"),!1):!0:(alert("請選擇付款方式"),!1):(alert("請選擇供應商"),!1),G=async o=>{try{const{data:e}=await v.get(`/purchaseReturns/${o}`);a.supplier_id=e.supplier.S_ID,a.date=e.PI_DATE,a.amount=e.PI_MONEY,a.payment_method=e.PI_PAYMENT,a.status=e.PI_STATUS,a.id=e.PI_ID,i.value=e.purchase_return_items.map(s=>({product_id:s.P_ID,name:s.product.P_NAME,price:s.P_PRICE,quantity:s.PI_QUANTITY,discount:s.PI_FOLD,cost:s.PI_COST,total:s.PI_TOTAL})),e.PI_STATUS==="1"?l.value="view":l.value="edit",D()}catch(e){console.error("獲取訂單資料失敗：",e),alert("獲取訂單資料失敗")}},H=_(""),J=_(null),i=_([]),K=o=>{i.value.push({product_id:o.P_ID,name:o.P_NAME,price:o.P_PRICE,quantity:1,discount:1,cost:o.P_PRICE,total:o.P_PRICE}),P(),at(()=>{var e;return(e=J.value)==null?void 0:e.focus()})},T=(o,e)=>{const s=i.value[o];e==="discount"?(s.discount=Math.round(s.discount*100)/100,s.cost=Math.round(s.price*s.discount)):e==="cost"&&(s.discount=Math.round(s.cost/s.price*100)/100),s.total=Math.round(s.cost*s.quantity),P()},P=()=>{a.amount=i.value.reduce((o,e)=>o+e.total,0)};O(()=>i.value.map(o=>o.cost),(o,e)=>{o.forEach((s,n)=>{const d=i.value[n];s!==e[n]&&(d.discount=Math.round(s/d.price*100)/100,d.total=Math.round(s*d.quantity))}),P()},{deep:!0});const W=o=>{i.value.splice(o,1),P()};O(w,()=>{S()}),st(()=>{$(),q()});const X=()=>{l.value="list",S()},Z=o=>{w.value=o,S()},V=o=>{l.value=o,p.value=o==="view",o==="add"&&U()};return(o,e)=>(r(),u("div",nt,[t("div",ct,[t("div",dt,[t("div",ut,[t("button",{type:"button",class:h(["btn btn-outline-info",{active:l.value==="add"}]),onClick:e[0]||(e[0]=s=>V("add"))}," 新增退貨單 ",2),l.value==="view"||l.value==="edit"?(r(),u("button",{key:0,type:"button",class:h(["btn btn-outline-info",{active:l.value==="edit"||l.value==="view"}]),onClick:e[1]||(e[1]=s=>V("edit"))}," 編輯退貨單 ",2)):g("",!0),t("button",{type:"button",class:h(["btn btn-outline-info",{active:l.value==="list"}]),onClick:X}," 退貨列表 ",2)])])]),l.value==="add"||l.value==="edit"||l.value==="view"?(r(),u("div",rt,[t("div",it,[t("div",pt,[e[7]||(e[7]=t("h5",{class:"mb-0"},"退貨資料　　",-1)),t("div",_t,[t("button",{class:h(["btn",F.value]),onClick:Y},c(x.value),3)])]),t("div",vt,[t("div",mt,[t("div",bt,[t("div",ht,[e[9]||(e[9]=t("label",{for:"supplier",class:"form-label"},"供應商",-1)),m(t("select",{id:"supplier",class:"form-select","onUpdate:modelValue":e[2]||(e[2]=s=>a.supplier_id=s),disabled:p.value},[e[8]||(e[8]=t("option",{value:""},"請選擇供應商",-1)),(r(!0),u(y,null,f(E.value,s=>(r(),u("option",{key:s.S_ID,value:s.S_ID},c(s.S_NAME),9,ft))),128))],8,yt),[[N,a.supplier_id]])])]),t("div",It,[t("div",wt,[e[10]||(e[10]=t("label",{for:"date",class:"form-label"},"日期",-1)),m(t("input",{type:"date",class:"form-control",id:"date","onUpdate:modelValue":e[3]||(e[3]=s=>a.date=s),disabled:p.value},null,8,Pt),[[I,a.date]])])]),t("div",gt,[t("div",kt,[e[11]||(e[11]=t("label",{for:"amount",class:"form-label"},"金額",-1)),m(t("input",{type:"number",class:"form-control",id:"amount","onUpdate:modelValue":e[4]||(e[4]=s=>a.amount=s),disabled:p.value,readonly:""},null,8,St),[[I,a.amount]])])]),t("div",Dt,[t("div",Tt,[e[13]||(e[13]=t("label",{for:"payment_method",class:"form-label"},"付款方式",-1)),m(t("select",{id:"payment_method",class:"form-select","onUpdate:modelValue":e[5]||(e[5]=s=>a.payment_method=s),disabled:p.value},e[12]||(e[12]=[t("option",{value:""},"請選擇退款方式",-1),t("option",{value:"扣貨款"},"扣款貨",-1),t("option",{value:"退現金"},"退現金",-1)]),8,Ct),[[N,a.payment_method]])])])])])]),t("div",Mt,[t("div",Et,[et(lt,{isDisabled:p.value,onAddProduct:K,source:"purchaseReturn"},null,8,["isDisabled"])])]),t("div",Vt,[t("div",At,[t("table",Ot,[e[14]||(e[14]=t("thead",null,[t("tr",null,[t("th",{scope:"col"},"#"),t("th",{scope:"col"},"書名"),t("th",{scope:"col"},"定價"),t("th",{scope:"col"},"數量"),t("th",{scope:"col"},"折扣"),t("th",{scope:"col"},"成本"),t("th",{scope:"col"},"小計"),t("th",{scope:"col"},"操作")])],-1)),t("tbody",null,[(r(!0),u(y,null,f(i.value,(s,n)=>(r(),u("tr",{key:n},[t("td",null,c(n+1),1),t("td",null,c(s.name),1),t("td",null,c(s.price),1),t("td",null,[m(t("input",{type:"number",class:"form-control form-control-sm","onUpdate:modelValue":d=>s.quantity=d,onInput:d=>T(n),disabled:p.value},null,40,Nt),[[I,s.quantity]])]),t("td",null,[m(t("input",{type:"number",class:"form-control form-control-sm","onUpdate:modelValue":d=>s.discount=d,onBlur:d=>T(n,"discount"),min:"0.01",max:"10",disabled:p.value},null,40,Ut),[[I,s.discount]])]),t("td",null,[m(t("input",{type:"number",class:"form-control form-control-sm","onUpdate:modelValue":d=>s.cost=d,onBlur:d=>T(n,"cost"),disabled:p.value},null,40,$t),[[I,s.cost]])]),t("td",null,c(s.total),1),t("td",null,[t("button",{class:"btn btn-sm btn-danger",onClick:d=>W(n),disabled:p.value}," 刪除 ",8,Rt)])]))),128))])])])])])):g("",!0),l.value==="list"?(r(),u("div",qt,[t("div",Bt,[t("div",xt,[t("div",Ft,[(r(),u(y,null,f(["1","2"],s=>t("button",{key:s,class:h(["btn btn-outline-info",{active:w.value===s}]),onClick:n=>Z(s)},c(s==="1"?"已完成":"編輯中"),11,Yt)),64))])]),t("div",jt,[t("table",Lt,[e[15]||(e[15]=t("thead",null,[t("tr",null,[t("th",{scope:"col"},"訂單編號"),t("th",{scope:"col"},"供應商"),t("th",{scope:"col"},"訂購日期"),t("th",{scope:"col"},"總金額"),t("th",{scope:"col"},"退款方式")])],-1)),t("tbody",null,[(r(!0),u(y,null,f(M.value,s=>(r(),u("tr",{key:s.PI_ID},[t("td",null,[t("a",{href:"#",onClick:ot(n=>B(s.PI_ID),["prevent"])},c(s.PI_ID),9,Qt)]),t("td",null,c(s.supplier.S_NAME),1),t("td",null,c(s.PI_DATE),1),t("td",null,c(s.PI_MONEY),1),t("td",null,c(s.PI_PAYMENT),1)]))),128))])])])])])):g("",!0),k.value?(r(),u("div",zt,[t("div",Gt,[t("div",Ht,[t("div",Jt,[t("h5",Kt,"訂單編號："+c(b.PI_ID),1),t("div",Wt,[t("button",{type:"button",class:"btn btn-primary btn-sm",onClick:e[6]||(e[6]=s=>G(b.PI_ID))}," 查看訂單 "),t("button",{type:"button",class:"btn-close",onClick:D})])]),t("div",Xt,[t("table",Zt,[e[16]||(e[16]=t("thead",null,[t("tr",null,[t("th",{scope:"col"},"書名"),t("th",{scope:"col"},"數量"),t("th",{scope:"col"},"成本")])],-1)),t("tbody",null,[(r(!0),u(y,null,f(b.purchase_return_items,s=>(r(),u("tr",{key:s.PI_ID},[t("td",null,c(s.product.P_NAME),1),t("td",null,c(s.PI_QUANTITY),1),t("td",null,c(s.PI_COST),1)]))),128))])])]),t("div",{class:"modal-footer"},[t("button",{type:"button",class:"btn btn-secondary",onClick:D},"關閉")])])])])):g("",!0)]))}},as=tt(ts,[["__scopeId","data-v-e60c43b6"]]);export{as as default};
