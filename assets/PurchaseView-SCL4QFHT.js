import{_ as tt,r as v,s as M,c as E,m as N,o as st,a as u,b as t,d as g,n as h,t as d,w as b,x as V,F as y,f,v as I,y as et,z as ot,g as _,j as at,h as i,i as lt,l as nt}from"./index-tvMXVzfh.js";import{I as dt}from"./ItemInput-DLxCqC5n.js";const ct={class:"container mt-4"},ut={class:"row mt-2 mb-4"},it={class:"col"},rt={class:"btn-group",role:"group"},pt={key:0},vt={class:"card mb-4"},_t={class:"card-header d-flex justify-content-between align-items-center"},bt={class:"btn-group"},mt={class:"card-body"},ht={class:"row"},yt={class:"col-md-3"},ft={class:"mb-3"},It=["disabled"],Pt=["value"],wt={class:"col-md-3"},gt={class:"mb-3"},kt=["disabled"],St={class:"col-md-3"},Dt={class:"mb-3"},Tt=["disabled"],Et={class:"col-md-3"},Ot={class:"mb-3"},At=["disabled"],Ct={class:"card mb-4"},Mt={class:"card-body"},Nt={class:"card"},Vt={class:"card-body"},Ut={class:"table"},$t=["onUpdate:modelValue","onInput","disabled"],Yt=["onUpdate:modelValue","onBlur","disabled"],qt=["onUpdate:modelValue","onBlur","disabled"],Bt=["onClick","disabled"],Lt={key:1},Gt={class:"card"},xt={class:"card-header"},Ft={class:"btn-group"},jt=["onClick"],Rt={class:"card-body"},Qt={class:"table"},zt=["onClick"],Jt={key:2,class:"modal fade show",tabindex:"-1",style:{display:"block"}},Ht={class:"modal-dialog"},Kt={class:"modal-content"},Wt={class:"modal-header"},Xt={class:"modal-title"},Zt={class:"d-flex align-items-center gap-2 ms-auto"},ts={class:"modal-body"},ss={class:"table"},es={__name:"PurchaseView",setup(os){at();const k=v(!1),O=v([]),m=M({items:[]}),P=v("1"),l=v("add"),p=E(()=>l.value==="view"),a=M({supplier_id:"",date:new Date().toISOString().split("T")[0],amount:0,payment_method:"",status:1}),U=()=>{Object.assign(a,{supplier_id:"",date:new Date().toISOString().split("T")[0],amount:0,payment_method:"",status:1}),r.value=[],J.value=""},A=v([]),$=async()=>{try{const{data:o}=await _.get("/suppliers");A.value=o}catch(o){console.error("獲取廠商列表失敗：",o)}},Y=v([]),q=async()=>{try{const{data:o}=await _.get("/products");Y.value=o}catch(o){console.error("獲取產品資料失敗：",o)}},S=async()=>{try{const{data:o}=await _.get(`/purchases?status=${P.value}`);O.value=o}catch(o){console.error("獲取進貨列表失敗：",o)}},B=async o=>{try{const{data:e}=await _.get(`/purchases/${o}`);Object.assign(m,e),k.value=!0,console.log("獲取進貨明細成功：",Object.assign(m,e))}catch(e){console.error("獲取訂單明細失敗：",e)}},D=()=>{k.value=!1},L=E(()=>{switch(l.value){case"add":return"新增";case"view":return"編輯";case"edit":return"完成";default:return""}}),G=E(()=>{switch(l.value){case"add":return"btn-primary";case"view":return"btn-warning";case"edit":return"btn-success";default:return"btn-primary"}}),x=async()=>{try{switch(l.value){case"add":if(!await F())return;l.value="view";break;case"view":await j(a.id),l.value="edit";break;case"edit":await R(a.id),l.value="view";break}}catch(o){console.error("操作失敗:",o),alert("操作失敗，請稍後再試")}},F=async()=>{if(!Q())return console.log("表單驗證失敗，停止執行"),!1;const o={supplier_id:a.supplier_id,date:a.date,amount:a.amount,payment_method:a.payment_method,status:1,items:r.value.map(s=>({product_id:s.product_id,price:s.price,quantity:s.quantity,discount:s.discount,cost:s.cost,total:s.total}))},{data:e}=await _.post("/purchases",o);return a.id=e.purchase_id,!0},j=async o=>{try{const{data:s}=await _.post(`/purchase/updateStatus/${o}`,{status:2});l.value="edit",console.log("更新訂單狀態成功"),alert("更新訂單成功")}catch(s){console.error("編輯訂單失敗：",s.message),alert("編輯訂單失敗")}},R=async o=>{console.log("正在執行 updatePurchase= ",o,", status=",a.status,"post_status=",1);try{const{data:s}=await _.post(`/purchase/updateStatus/${o}`,{status:1,supplier_id:a.supplier_id,amount:a.amount,payment_method:a.payment_method,items:r.value.map(n=>({product_id:n.product_id,price:n.price,quantity:n.quantity,discount:n.discount,cost:n.cost,total:n.total}))});l.value="view",console.log("更新訂單成功"),alert("更新訂單成功")}catch(s){console.error("編輯訂單失敗：",s.message),alert("編輯訂單失敗")}},Q=()=>a.supplier_id?a.payment_method?r.value.length===0?(alert("請至少新增一筆進貨明細"),!1):!0:(alert("請選擇付款方式"),!1):(alert("請選擇供應商"),!1),z=async o=>{try{const{data:e}=await _.get(`/purchases/${o}`);a.supplier_id=e.supplier.S_ID,a.date=e.PI_DATE,a.amount=e.PI_MONEY,a.payment_method=e.PI_PAYMENT,a.status=e.PI_STATUS,a.id=e.PI_ID,r.value=e.purchase_products.map(s=>({product_id:s.P_ID,name:s.product.P_NAME,price:s.P_PRICE,quantity:s.PI_QUANTITY,discount:s.PI_FOLD,cost:s.PI_COST,total:s.PI_TOTAL})),e.PI_STATUS==="1"?l.value="view":l.value="edit",D()}catch(e){console.error("獲取訂單資料失敗：",e),alert("獲取訂單資料失敗")}},J=v(""),H=v(null),r=v([]),K=o=>{r.value.push({product_id:o.P_ID,name:o.P_NAME,price:o.P_PRICE,quantity:1,discount:1,cost:o.P_PRICE,total:o.P_PRICE}),w(),nt(()=>{var e;return(e=H.value)==null?void 0:e.focus()})},T=(o,e)=>{const s=r.value[o];e==="discount"?(s.discount=Math.round(s.discount*100)/100,s.cost=Math.round(s.price*s.discount)):e==="cost"&&(s.discount=Math.round(s.cost/s.price*100)/100),s.total=Math.round(s.cost*s.quantity),w()},w=()=>{a.amount=r.value.reduce((o,e)=>o+e.total,0)};N(()=>r.value.map(o=>o.cost),(o,e)=>{o.forEach((s,n)=>{const c=r.value[n];s!==e[n]&&(c.discount=Math.round(s/c.price*100)/100,c.total=Math.round(s*c.quantity))}),w()},{deep:!0});const W=o=>{r.value.splice(o,1),w()};N(P,()=>{S()}),st(()=>{$(),q()});const X=()=>{l.value="list",S()},Z=o=>{P.value=o,S()},C=o=>{l.value=o,p.value=o==="view",o==="add"&&U()};return(o,e)=>(i(),u("div",ct,[t("div",ut,[t("div",it,[t("div",rt,[t("button",{type:"button",class:h(["btn btn-outline-info",{active:l.value==="add"}]),onClick:e[0]||(e[0]=s=>C("add"))}," 新增進貨單 ",2),l.value==="view"||l.value==="edit"?(i(),u("button",{key:0,type:"button",class:h(["btn btn-outline-info",{active:l.value==="edit"||l.value==="view"}]),onClick:e[1]||(e[1]=s=>C("edit"))}," 編輯進貨單 ",2)):g("",!0),t("button",{type:"button",class:h(["btn btn-outline-info",{active:l.value==="list"}]),onClick:X}," 進貨列表 ",2)])])]),l.value==="add"||l.value==="edit"||l.value==="view"?(i(),u("div",pt,[t("div",vt,[t("div",_t,[e[7]||(e[7]=t("h5",{class:"mb-0"},"進貨資料　　",-1)),t("div",bt,[t("button",{class:h(["btn",G.value]),onClick:x},d(L.value),3)])]),t("div",mt,[t("div",ht,[t("div",yt,[t("div",ft,[e[9]||(e[9]=t("label",{for:"supplier",class:"form-label"},"供應商",-1)),b(t("select",{id:"supplier",class:"form-select","onUpdate:modelValue":e[2]||(e[2]=s=>a.supplier_id=s),disabled:p.value},[e[8]||(e[8]=t("option",{value:""},"請選擇供應商",-1)),(i(!0),u(y,null,f(A.value,s=>(i(),u("option",{key:s.S_ID,value:s.S_ID},d(s.S_NAME),9,Pt))),128))],8,It),[[V,a.supplier_id]])])]),t("div",wt,[t("div",gt,[e[10]||(e[10]=t("label",{for:"date",class:"form-label"},"日期",-1)),b(t("input",{type:"date",class:"form-control",id:"date","onUpdate:modelValue":e[3]||(e[3]=s=>a.date=s),disabled:p.value},null,8,kt),[[I,a.date]])])]),t("div",St,[t("div",Dt,[e[11]||(e[11]=t("label",{for:"amount",class:"form-label"},"金額",-1)),b(t("input",{type:"number",class:"form-control",id:"amount","onUpdate:modelValue":e[4]||(e[4]=s=>a.amount=s),disabled:p.value,readonly:""},null,8,Tt),[[I,a.amount]])])]),t("div",Et,[t("div",Ot,[e[13]||(e[13]=t("label",{for:"payment_method",class:"form-label"},"付款方式",-1)),b(t("select",{id:"payment_method",class:"form-select","onUpdate:modelValue":e[5]||(e[5]=s=>a.payment_method=s),disabled:p.value},e[12]||(e[12]=[et('<option value="" data-v-226d3abe>請選擇付款方式</option><option value="現金" data-v-226d3abe>現金</option><option value="轉帳" data-v-226d3abe>轉帳</option><option value="街口 GOGO" data-v-226d3abe>街口 GOGO</option><option value="LINE PAY Daway" data-v-226d3abe>LINE PAY Daway</option><option value="LINE PAY GOGO" data-v-226d3abe>LINE PAY GOGO</option><option value="LINE PAY J卡" data-v-226d3abe>LINE PAY J卡</option><option value="信用卡" data-v-226d3abe>信用卡</option>',8)]),8,At),[[V,a.payment_method]])])])])])]),t("div",Ct,[t("div",Mt,[ot(dt,{isDisabled:p.value,onAddProduct:K,source:"purchase"},null,8,["isDisabled"])])]),t("div",Nt,[t("div",Vt,[t("table",Ut,[e[14]||(e[14]=t("thead",null,[t("tr",null,[t("th",{scope:"col"},"#"),t("th",{scope:"col"},"書名"),t("th",{scope:"col"},"定價"),t("th",{scope:"col"},"數量"),t("th",{scope:"col"},"折扣"),t("th",{scope:"col"},"成本"),t("th",{scope:"col"},"小計"),t("th",{scope:"col"},"操作")])],-1)),t("tbody",null,[(i(!0),u(y,null,f(r.value,(s,n)=>(i(),u("tr",{key:n},[t("td",null,d(n+1),1),t("td",null,d(s.name),1),t("td",null,d(s.price),1),t("td",null,[b(t("input",{type:"number",class:"form-control form-control-sm","onUpdate:modelValue":c=>s.quantity=c,onInput:c=>T(n),disabled:p.value},null,40,$t),[[I,s.quantity]])]),t("td",null,[b(t("input",{type:"number",class:"form-control form-control-sm","onUpdate:modelValue":c=>s.discount=c,onBlur:c=>T(n,"discount"),min:"0.01",max:"10",disabled:p.value},null,40,Yt),[[I,s.discount]])]),t("td",null,[b(t("input",{type:"number",class:"form-control form-control-sm","onUpdate:modelValue":c=>s.cost=c,onBlur:c=>T(n,"cost"),disabled:p.value},null,40,qt),[[I,s.cost]])]),t("td",null,d(s.total),1),t("td",null,[t("button",{class:"btn btn-sm btn-danger",onClick:c=>W(n),disabled:p.value}," 刪除 ",8,Bt)])]))),128))])])])])])):g("",!0),l.value==="list"?(i(),u("div",Lt,[t("div",Gt,[t("div",xt,[t("div",Ft,[(i(),u(y,null,f(["1","2"],s=>t("button",{key:s,class:h(["btn btn-outline-info",{active:P.value===s}]),onClick:n=>Z(s)},d(s==="1"?"已完成":"編輯中"),11,jt)),64))])]),t("div",Rt,[t("table",Qt,[e[15]||(e[15]=t("thead",null,[t("tr",null,[t("th",{scope:"col"},"訂單編號"),t("th",{scope:"col"},"供應商"),t("th",{scope:"col"},"訂購日期"),t("th",{scope:"col"},"總金額"),t("th",{scope:"col"},"付款方式")])],-1)),t("tbody",null,[(i(!0),u(y,null,f(O.value,s=>(i(),u("tr",{key:s.PI_ID},[t("td",null,[t("a",{href:"#",onClick:lt(n=>B(s.PI_ID),["prevent"])},d(s.PI_ID),9,zt)]),t("td",null,d(s.supplier.S_NAME),1),t("td",null,d(s.PI_DATE),1),t("td",null,d(s.PI_MONEY),1),t("td",null,d(s.PI_PAYMENT),1)]))),128))])])])])])):g("",!0),k.value?(i(),u("div",Jt,[t("div",Ht,[t("div",Kt,[t("div",Wt,[t("h5",Xt,"訂單編號："+d(m.PI_ID),1),t("div",Zt,[t("button",{type:"button",class:"btn btn-primary btn-sm",onClick:e[6]||(e[6]=s=>z(m.PI_ID))}," 查看訂單 "),t("button",{type:"button",class:"btn-close",onClick:D})])]),t("div",ts,[t("table",ss,[e[16]||(e[16]=t("thead",null,[t("tr",null,[t("th",{scope:"col"},"書名"),t("th",{scope:"col"},"數量"),t("th",{scope:"col"},"成本")])],-1)),t("tbody",null,[(i(!0),u(y,null,f(m.purchase_products,s=>(i(),u("tr",{key:s.PI_ID},[t("td",null,d(s.product.P_NAME),1),t("td",null,d(s.PI_QUANTITY),1),t("td",null,d(s.PI_COST),1)]))),128))])])]),t("div",{class:"modal-footer"},[t("button",{type:"button",class:"btn btn-secondary",onClick:D},"關閉")])])])])):g("",!0)]))}},ns=tt(es,[["__scopeId","data-v-226d3abe"]]);export{ns as default};
