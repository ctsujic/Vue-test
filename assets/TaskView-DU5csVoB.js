import{_ as st,r as m,c as x,o as lt,m as at,A as ot,a as o,b as t,d as S,n as g,i as nt,w as C,x as j,y as ut,v as D,z as dt,F as A,f as E,e as U,t as r,g as I,l as V,h as n}from"./index-tvMXVzfh.js";import{I as rt}from"./ItemInput-DLxCqC5n.js";import{$ as z}from"./dataTables.bootstrap5.min-DfwQAa5e.js";const it={class:"task-manager"},ct={class:"btn-group mb-4",role:"group"},vt={key:0},bt={class:"card mb-4"},pt={class:"card-body"},_t={class:"row"},mt={class:"col-md-3"},ft={class:"mb-3"},Tt={class:"col-md-3"},yt={class:"mb-3"},kt={class:"col-md-3"},ht={class:"mb-3"},St=["value"],gt={class:"col-md-3"},Ct={class:"mb-3"},At={class:"card mb-4"},Lt={class:"card-body"},xt={class:"card"},Dt={class:"card-body"},Et={class:"table"},Ut=["onUpdate:modelValue","disabled"],It=["onUpdate:modelValue","disabled"],Nt=["onUpdate:modelValue","disabled"],Mt=["onUpdate:modelValue","disabled"],wt=["onClick","disabled"],Rt={key:0},Vt={key:1},$t={class:"btn-group mb-3",role:"group","aria-label":"Basic outlined example"},Ot={class:"badge bg-success rounded-pill"},Pt=["onClick"],Bt={class:"badge bg-success rounded-pill"},qt={class:"badge bg-success rounded-pill"},Ft={class:"row mt-2"},jt={class:"col"},zt={class:"table table-hover"},Kt={scope:"row"},Wt=["onClick"],Gt={style:{color:"red"}},Ht={key:0},Jt={key:2},Qt={class:"card"},Xt={class:"card-body"},Yt={key:0},Zt={class:"modal-dialog"},te={class:"modal-content"},ee={class:"modal-header"},se={class:"modal-title",id:"taskDetailModalLabel"},le={class:"modal-body"},ae={class:"table table-hover"},oe={key:0},ne={__name:"TaskView",setup(ue){const v=m("add"),k=m([]),N=m([]),i=m({class:"預購",total:0,source:"蝦皮",orderId:""}),h=m(!1),y=m([]),B=x(()=>y.value.length),K=s=>{y.value.push({product_id:s.P_ID,class:"",name:s.P_NAME,price:s.P_PRICE,quantity:1})},W=s=>{y.value.splice(s,1)},b=m({type:"all",value:null}),$=(s,e)=>{b.value={type:s,value:e}},L=async()=>{try{const[s,e]=await Promise.all([I.get("/tasks"),I.get("/products")]);k.value=s.data,N.value=e.data,v.value==="list_total"&&(await V(),P())}catch(s){console.error("獲取任務或產品資料失敗：",s),alert("數據加載失敗，請稍後再試。")}},q=x(()=>k.value.filter(s=>{if(b.value.type==="status")return s.T_STATUS===b.value.value;if(s.T_STATUS!=="1"&&b.value.type!=="status")return!1;switch(b.value.type){case"source":return s.T_SOURCE===b.value.value&&s.T_STATUS==="1";case"all":default:return s.T_STATUS==="1"}})),G=x(()=>{const s=new Set;return k.value.filter(e=>e.T_STATUS==="1").forEach(e=>{s.add(e.T_SOURCE)}),Array.from(s)}),H=s=>k.value.filter(e=>e.T_SOURCE===s&&e.T_STATUS==="1").length,J=x(()=>k.value.filter(s=>s.T_STATUS==="2").length),Q=async()=>{if(y.value.length===0){alert("請至少新增一個銷貨品項！");return}if(!i.value.orderId.trim()){alert("訂單編號為必填項！");return}if(y.value.filter(u=>!u.class||!u.class.trim()).length>0){alert("銷貨明細中所有品項都必須輸入月份！");return}i.value.total=B.value;const e={T_CLASS:i.value.class,T_TOTAL:i.value.total,T_SOURCE:i.value.source,T_ORDERID:i.value.orderId,T_STATUS:"1",task_list:y.value.map(u=>({TL_CLASS:u.class,TL_NAME:u.name,TL_NB:u.quantity}))};try{h.value=!0;const u=await I.post("/tasks",e);console.log("任務新增成功",u.data),alert("任務新增成功！"),i.value={class:"預購",total:0,source:"蝦皮",orderId:""},y.value=[],await L()}catch(u){console.error("任務新增失敗",u),alert("任務新增失敗，請檢查資料或稍後再試。")}finally{h.value=!1}},O=async s=>{v.value=s,p.value&&s!=="list_total"&&(p.value.destroy(),p.value=null),(s==="list"||s==="list_total")&&(k.value.length===0||N.value.length===0?await L():s==="list_total"&&(await V(),P()))};lt(()=>{L()});const p=m(null),F=m("taskStatsInit-"+Date.now()),M=x(()=>{const s={};k.value.filter(d=>d.T_STATUS==="1").forEach(d=>{d.tasklist.forEach(a=>{const _=`${a.TL_CLASS}-${a.TL_NAME}`;s[_]||(s[_]={class:a.TL_CLASS,name:a.TL_NAME,total:0,stock:0}),s[_].total+=Number(a.TL_NB)})});const e=new Map;N.value.forEach(d=>{e.set(d.P_NAME,d.P_STOCK)});for(const d in s)s[d].stock=e.get(s[d].name)||0;const u=Object.values(s);return u.sort((d,a)=>{const _=String(d.class||"").localeCompare(String(a.class||""));return _!==0?_:String(d.name||"").localeCompare(String(a.name||""))}),u}),X=(s,e)=>s>=e?"充足":s===0&&e>0?"無庫存":s<e?`短缺 ${e-s}`:e===0&&s>=0?"需求為0":"未知",P=async()=>{p.value&&(p.value.destroy(),p.value=null),F.value="taskStats-"+Date.now(),await V();const s=document.getElementById("taskStatsDataTable");if(v.value==="list_total"&&s){const e={data:[],columns:[{data:"class",title:"月份"},{data:"name",title:"書名"},{data:"total",title:"總需求數量",className:"text-end",type:"num"},{data:"stock",title:"當前庫存",className:"text-end",type:"num"},{data:null,title:"庫存狀態",orderable:!0,className:"text-end",render:function(u,d,a){const _=X(a.stock,a.total);let l="";return a.stock>=a.total?l="text-success":a.stock<a.total&&a.stock>0?l="text-warning":a.stock===0&&a.total>0&&(l="text-danger"),`<span class="${l}">${_}</span>`}}],ordering:!0,order:[[0,"asc"],[1,"asc"]],paging:!1,searching:!1,info:!1,responsive:!0,dom:'rt<"bottom"p>',language:{emptyTable:"目前沒有未完成任務統計資料",loadingRecords:"載入中...",processing:"處理中...",zeroRecords:"沒有匹配結果"}};M.value.length>0?(e.data=M.value,p.value=z(s).DataTable(e)):p.value=z(s).DataTable(e)}};at(M,async(s,e)=>{v.value==="list_total"&&(await V(),P())},{deep:!0});const w=m(!1),f=m(null),Y=s=>{f.value=s,w.value=!0},R=()=>{w.value=!1,f.value=null},Z=async()=>{if(f.value)try{await I.put(`/tasks/${f.value.T_ID}`,{T_STATUS:"2"}),alert("任務已標記為已完成"),R(),await L()}catch(s){console.error("完成任務失敗:",s),alert("操作失敗，請稍後再試")}},tt=async()=>{if(f.value&&confirm(`確定要刪除訂單編號 ${f.value.T_ORDERID} 的任務嗎？此操作無法復原！`))try{await I.delete(`/tasks/${f.value.T_ID}`),alert("任務已刪除"),R(),await L()}catch(s){console.error("刪除任務失敗:",s),alert("刪除失敗，請稍後再試")}},et=s=>{const e=N.value.find(u=>u.P_NAME===s);return e?e.P_STOCK:"無資料"};return ot(()=>{p.value&&(p.value.destroy(),p.value=null)}),(s,e)=>{var u,d,a,_;return n(),o("div",it,[t("div",ct,[t("button",{onClick:e[0]||(e[0]=l=>O("add")),class:g(["btn btn-outline-info",{active:v.value==="add"}])},"新增任務",2),t("button",{onClick:e[1]||(e[1]=l=>O("list")),class:g(["btn btn-outline-info",{active:v.value==="list"}])},"任務清單",2),t("button",{onClick:e[2]||(e[2]=l=>O("list_total")),class:g(["btn btn-outline-info",{active:v.value==="list_total"}])},"任務統計",2)]),v.value==="add"?(n(),o("div",vt,[t("div",bt,[t("form",{onSubmit:nt(Q,["prevent"])},[e[14]||(e[14]=t("div",{class:"card-header d-flex justify-content-around align-items-center"},[t("h5",{class:"mb-0"},"任務資料　　"),t("div",{class:"btn-group ml-10"},[t("button",{type:"submit",class:"input-group-text btn btn-success"},"送出")])],-1)),t("div",pt,[t("div",_t,[t("div",mt,[t("div",ft,[e[9]||(e[9]=t("label",{for:"TL_CLASS",class:"form-label"},"分類",-1)),C(t("select",{id:"TL_CLASS",class:"form-select","onUpdate:modelValue":e[3]||(e[3]=l=>i.value.class=l)},e[8]||(e[8]=[t("option",{value:"預購"},"預購",-1),t("option",{value:"待辦事項"},"待辦事項",-1)]),512),[[j,i.value.class]])])]),t("div",Tt,[t("div",yt,[e[11]||(e[11]=t("label",{for:"order",class:"form-label"},"來源",-1)),C(t("select",{"onUpdate:modelValue":e[4]||(e[4]=l=>i.value.source=l),id:"order",class:"form-select"},e[10]||(e[10]=[ut('<option value="蝦皮" data-v-289ea1f0>蝦皮</option><option value="iOPEN" data-v-289ea1f0>iOPEN</option><option value="買動漫" data-v-289ea1f0>買動漫</option><option value="官網" data-v-289ea1f0>官網</option><option value="其他" data-v-289ea1f0>其他</option>',5)]),512),[[j,i.value.source]])])]),t("div",kt,[t("div",ht,[e[12]||(e[12]=t("label",{for:"amount",class:"form-label"},"筆數",-1)),t("input",{type:"number",class:"form-control",id:"amount",value:B.value,disabled:""},null,8,St)])]),t("div",gt,[t("div",Ct,[e[13]||(e[13]=t("label",{for:"siorder",class:"form-label"},"訂單編號",-1)),C(t("input",{type:"text",class:"form-control","onUpdate:modelValue":e[5]||(e[5]=l=>i.value.orderId=l),required:""},null,512),[[D,i.value.orderId]])])])])])],32)]),t("div",At,[t("div",Lt,[dt(rt,{isDisabled:h.value,onAddProduct:K,source:"task"},null,8,["isDisabled"])])]),t("div",xt,[t("div",Dt,[t("table",Et,[e[16]||(e[16]=t("thead",null,[t("tr",null,[t("th",{scope:"col"},"#"),t("th",{scope:"col"},"月份"),t("th",{scope:"col"},"書名"),t("th",{scope:"col"},"定價"),t("th",{scope:"col"},"數量"),t("th",{scope:"col"},"操作")])],-1)),t("tbody",null,[(n(!0),o(A,null,E(y.value,(l,c)=>(n(),o("tr",{key:c},[t("td",null,r(c+1),1),t("td",null,[C(t("input",{type:"text",class:"form-control form-control-sm","onUpdate:modelValue":T=>l.class=T,disabled:h.value,placeholder:"輸入月份",required:""},null,8,Ut),[[D,l.class]])]),t("td",null,[C(t("input",{type:"text",class:"form-control form-control-sm","onUpdate:modelValue":T=>l.name=T,disabled:h.value},null,8,It),[[D,l.name]])]),t("td",null,[C(t("input",{type:"number",class:"form-control form-control-sm","onUpdate:modelValue":T=>l.price=T,disabled:h.value},null,8,Nt),[[D,l.price,void 0,{number:!0}]])]),t("td",null,[C(t("input",{type:"number",class:"form-control form-control-sm","onUpdate:modelValue":T=>l.quantity=T,disabled:h.value},null,8,Mt),[[D,l.quantity,void 0,{number:!0}]])]),t("td",null,[t("button",{class:"btn btn-sm btn-danger",onClick:T=>W(c),disabled:h.value}," 刪除 ",8,wt)])]))),128)),y.value.length?S("",!0):(n(),o("tr",Rt,e[15]||(e[15]=[t("td",{colspan:"6",class:"text-center text-muted"},"尚未新增品項",-1)])))])])])])])):S("",!0),v.value==="list"?(n(),o("div",Vt,[t("div",$t,[t("button",{onClick:e[6]||(e[6]=l=>$("all",null)),class:g(["btn btn-outline-success",{active:b.value.type==="all"}])},[e[17]||(e[17]=U(" 未完成任務 ")),t("span",Ot,r(k.value.filter(l=>l.T_STATUS==="1").length),1)],2),(n(!0),o(A,null,E(G.value,l=>(n(),o("button",{key:l,onClick:c=>$("source",l),class:g(["btn btn-outline-success",{active:b.value.type==="source"&&b.value.value===l}])},[U(r(l)+" ",1),t("span",Bt,r(H(l)),1)],10,Pt))),128)),t("button",{onClick:e[7]||(e[7]=l=>$("status","2")),class:g(["btn btn-outline-success",{active:b.value.type==="status"&&b.value.value==="2"}])},[e[18]||(e[18]=U(" 已完成任務 ")),t("span",qt,r(J.value),1)],2)]),t("div",Ft,[t("div",jt,[t("table",zt,[e[20]||(e[20]=t("thead",{class:"table-info"},[t("tr",null,[t("th",{scope:"col"},"訂單編號"),t("th",{scope:"col"},"數量"),t("th",{scope:"col"},"當前庫存"),t("th",{scope:"col"},"月份"),t("th",{scope:"col"},"書名")])],-1)),t("tbody",null,[(n(!0),o(A,null,E(q.value,l=>(n(),o(A,{key:l.T_ID},[(n(!0),o(A,null,E(l.tasklist,(c,T)=>(n(),o("tr",{key:l.T_ID+"-"+(c.TL_ID||T)},[t("th",Kt,[t("button",{type:"button",class:"btn btn-info btn-sm",onClick:de=>Y(l)},r(l.T_ORDERID),9,Wt)]),t("td",null,r(c.TL_NB),1),t("td",Gt,r(et(c.TL_NAME)),1),t("td",null,r(c.TL_CLASS),1),t("td",null,r(c.TL_NAME),1)]))),128))],64))),128)),q.value.length?S("",!0):(n(),o("tr",Ht,e[19]||(e[19]=[t("td",{colspan:"5",class:"text-center text-muted"},"無符合條件的任務",-1)])))])])])])])):S("",!0),v.value==="list_total"?(n(),o("div",Jt,[t("div",Qt,[e[23]||(e[23]=t("div",{class:"card-header"},[t("h5",{class:"mb-0"},"未完成任務統計")],-1)),t("div",Xt,[(n(),o("table",{class:"table table-hover",id:"taskStatsDataTable",key:F.value,style:{width:"100%"}},[e[22]||(e[22]=t("thead",{class:"table-info"},[t("tr",null,[t("th",{scope:"col"},"月份"),t("th",{scope:"col"},"書名"),t("th",{scope:"col"},"總需求數量"),t("th",{scope:"col"},"當前庫存"),t("th",{scope:"col"},"庫存狀態")])],-1)),t("tbody",null,[M.value.length===0&&v.value==="list_total"?(n(),o("tr",Yt,e[21]||(e[21]=[t("td",{colspan:"5",class:"text-center text-muted"},"無未完成任務統計資料",-1)]))):S("",!0)])]))])])])):S("",!0),w.value?(n(),o("div",{key:3,class:g(["modal fade",{show:w.value}]),style:{display:"block","background-color":"rgba(0, 0, 0, 0.5)"},tabindex:"-1","aria-labelledby":"taskDetailModalLabel","aria-hidden":"true"},[t("div",Zt,[t("div",te,[t("div",ee,[t("h5",se,"訂單編號："+r((u=f.value)==null?void 0:u.T_ORDERID),1),t("button",{type:"button",class:"btn-close",onClick:R,"aria-label":"Close"})]),t("div",le,[t("div",{class:"d-grid gap-2 d-md-flex justify-content-md-end mb-4"},[t("button",{type:"button",class:"btn btn-success",onClick:Z},e[24]||(e[24]=[t("i",{class:"bi bi-check-circle"},null,-1),U(" 完成 ")])),t("button",{type:"button",class:"btn btn-danger",onClick:tt},e[25]||(e[25]=[t("i",{class:"bi bi-trash"},null,-1),U(" 刪除 ")]))]),t("table",ae,[e[27]||(e[27]=t("thead",{class:"table-light"},[t("tr",null,[t("th",{scope:"col"},"月份"),t("th",{scope:"col"},"書名"),t("th",{scope:"col"},"數量")])],-1)),t("tbody",null,[(n(!0),o(A,null,E((d=f.value)==null?void 0:d.tasklist,(l,c)=>(n(),o("tr",{key:c},[t("td",null,r(l.TL_CLASS),1),t("td",null,r(l.TL_NAME),1),t("td",null,r(l.TL_NB),1)]))),128)),(_=(a=f.value)==null?void 0:a.tasklist)!=null&&_.length?S("",!0):(n(),o("tr",oe,e[26]||(e[26]=[t("td",{colspan:"3",class:"text-center text-muted"},"無明細資料",-1)])))])])]),t("div",{class:"modal-footer"},[t("button",{type:"button",class:"btn btn-secondary",onClick:R}," 關閉 ")])])])],2)):S("",!0)])}}},ve=st(ne,[["__scopeId","data-v-289ea1f0"]]);export{ve as default};
